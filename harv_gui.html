<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harv v2.0 - Intelligent Tutoring System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    <style>
        /* Professional Color Palette */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --surface: #ffffff;
            --background: #f8fafc;
            --border: #e2e8f0;
            --text: #0f172a;
            --text-muted: #64748b;
            --accent: #0ea5e9;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text);
            margin: 0;
            padding: 0;
        }

        /* Header */
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .nav {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .nav-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: none;
        }

        .nav-btn:hover,
        .nav-btn.active {
            color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-indicator.connected {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Page Sections */
        .page-section {
            display: none;
            min-height: calc(100vh - 64px);
        }

        .page-section.active {
            display: block;
        }

        /* Chat Layout */
        .chat-container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            height: calc(100vh - 64px);
            gap: 1px;
            background: var(--border);
        }

        .chat-sidebar,
        .chat-main,
        .chat-memory {
            background: var(--surface);
        }

        .chat-sidebar,
        .chat-memory {
            overflow-y: auto;
            padding: 1.5rem;
        }

        .chat-main {
            display: flex;
            flex-direction: column;
        }

        .chat-memory {
            background: #1e293b;
            color: white;
        }

        /* Messages */
        .message {
            max-width: 80%;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease-out;
        }

        .message.user {
            margin-left: auto;
        }

        .message-content {
            padding: 1rem 1.25rem;
            border-radius: 16px;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: #f1f5f9;
            color: var(--text);
            border-bottom-left-radius: 4px;
        }

        .message-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            padding: 0 0.25rem;
        }

        /* Input Area */
        .chat-input-container {
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 1.5rem;
            display: flex;
            gap: 0.75rem;
            align-items: end;
        }

        .chat-input-field {
            flex: 1;
            padding: 0.875rem 1rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 0.875rem;
            background: var(--surface);
            resize: none;
            max-height: 120px;
            min-height: 44px;
            transition: all 0.2s ease;
        }

        .chat-input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .chat-send-button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.875rem 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            height: 44px;
        }

        .chat-send-button:hover {
            background: var(--primary-hover);
        }

        .chat-send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* Module Cards */
        .module-card {
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border);
        }

        .module-card.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .module-card:not(.active):hover {
            background: #f8fafc;
            border-color: var(--primary);
        }

        /* Memory Layers */
        .memory-layer {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 3px solid var(--success);
        }

        .memory-layer.error {
            border-left-color: #ef4444;
        }

        /* Tabs */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            border-radius: 12px 12px 0 0;
        }

        .tab-button {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .tab-button.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .tab-button:hover:not(.active) {
            color: var(--text);
            background: rgba(0, 0, 0, 0.02);
        }

        .tab-content {
            display: none;
            padding: 2rem;
            background: var(--surface);
        }

        .tab-content.active {
            display: block;
        }

        /* Form Elements */
        .form-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            background: #f8fafc;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-field {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        /* Module List */
        .module-list {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .module-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .module-item:hover {
            background: #f8fafc;
        }

        .module-item.active {
            background: rgba(37, 99, 235, 0.1);
            border-left: 4px solid var(--primary);
        }

        .module-item:last-child {
            border-bottom: none;
        }

        /* Buttons */
        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        /* Save Status */
        .save-status {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            margin-left: 1rem;
            display: none;
        }

        .save-status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .save-status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Loading States */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Error Messages */
        .error-banner {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            border: 1px solid #fecaca;
            display: none;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .chat-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
            
            .chat-sidebar,
            .chat-memory {
                height: 200px;
            }
        }

        /* Scrollbars */
        .custom-scroll {
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Error Banner -->
    <div id="errorBanner" class="error-banner">
        <strong>Backend Connection Failed:</strong> 
        <span id="errorMessage">Unable to connect to backend server.</span>
        <br><small>Make sure the backend is running at http://localhost:8000</small>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <i data-lucide="brain" class="w-5 h-5 text-white"></i>
            </div>
            <div class="logo-text">Harv v2.0</div>
        </div>
        
        <nav class="nav">
            <button onclick="showPage('chat')" class="nav-btn active">Learn</button>
            <button onclick="showPage('memory')" class="nav-btn">Memory</button>
            <button onclick="showPage('config')" class="nav-btn">Configure</button>
            <button onclick="showPage('analytics')" class="nav-btn">Analytics</button>
            <div class="connection-status">
                <div class="status-indicator" id="connectionIndicator"></div>
                <span>Backend: <span id="backendStatus">Connecting...</span></span>
            </div>
        </nav>
    </header>

    <!-- CHAT PAGE -->
    <section id="chat" class="page-section active">
        <div class="chat-container">
            <!-- Left Sidebar -->
            <div class="chat-sidebar custom-scroll">
                <h2 class="text-lg font-semibold mb-4">Learning Modules</h2>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="font-medium mb-2">Course Outline</h3>
                    <div class="text-sm text-slate-600">Communication & Media Society</div>
                    <div class="text-xs text-slate-500 mt-1">15 Modules • Socratic Method</div>
                </div>
                
                <div id="modulesList" class="space-y-3 mb-6">
                    <!-- Modules loaded from backend -->
                </div>

                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4" id="currentModuleInfo">
                    <h3 class="font-medium mb-3">Loading module info...</h3>
                </div>
            </div>

            <!-- Chat Main -->
            <div class="chat-main">
                <div class="p-4 border-b border-slate-200 bg-slate-50">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold" id="chatModuleTitle">Loading...</h3>
                            <p class="text-sm text-slate-600">AI Tutor • Socratic Method Active</p>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-slate-600">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" id="memoryIndicator"></div>
                            <span>Memory: <span id="memoryStatus">Checking...</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="flex-1 p-6 overflow-y-auto custom-scroll" id="chatMessages">
                    <div class="message assistant">
                        <div class="message-content">
                            Welcome to Module 1: Your Four Worlds! I'm your AI tutor, and I'll guide you through discovering key communication concepts using the Socratic method. Let's start with a question: Think about a recent news event - how did you first learn about it, and have you seen it discussed differently on different platforms?
                        </div>
                        <div class="message-meta">Just now • Enhanced memory system loading...</div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <textarea 
                        id="messageInput"
                        placeholder="Share your thoughts about communication..."
                        class="chat-input-field"
                        rows="1"
                    ></textarea>
                    <button onclick="sendMessage()" class="chat-send-button" id="sendButton">
                        <i data-lucide="send" class="w-4 h-4"></i>
                        Send
                    </button>
                </div>
            </div>

            <!-- Memory Panel -->
            <div class="chat-memory custom-scroll">
                <h2 class="text-lg font-semibold mb-6">Live Memory System</h2>
                
                <div class="space-y-4" id="memoryLayers">
                    <div class="memory-layer">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                            <span class="font-semibold text-sm">Memory System Loading...</span>
                        </div>
                        <div class="text-xs text-slate-300">
                            <div>Connecting to backend...</div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 bg-slate-800 rounded-lg p-4">
                    <h3 class="font-semibold mb-3 text-sm">Context Metrics</h3>
                    <div class="space-y-2 text-xs" id="contextMetrics">
                        <div class="flex justify-between text-slate-300">
                            <span>Backend status:</span>
                            <span class="text-yellow-400 font-mono">Connecting...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- MEMORY PAGE -->
    <section id="memory" class="page-section">
        <div class="p-6">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-12">
                    <h1 class="text-4xl font-bold mb-4">4-Layer Memory Architecture</h1>
                    <p class="text-xl text-slate-600">Live visualization of enhanced memory system processing</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="form-section">
                        <div class="section-header">
                            <i data-lucide="layers" class="w-5 h-5"></i>
                            Memory Layers Status
                        </div>
                        <div class="p-6 space-y-4" id="memoryLayersDetailed">
                            <!-- Detailed memory layers populated by JavaScript -->
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-header">
                            <i data-lucide="bar-chart" class="w-5 h-5"></i>
                            Memory Performance Metrics
                        </div>
                        <div class="p-6" id="memoryMetricsDetailed">
                            <!-- Detailed metrics populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CONFIG PAGE -->
    <section id="config" class="page-section">
        <div class="p-6">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h1 class="text-4xl font-bold mb-2">Module Configuration Editor</h1>
                        <p class="text-xl text-slate-600">Design and configure your 15-module communication curriculum</p>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="save-status" id="saveStatus"></div>
                        <button onclick="saveModule()" class="btn-primary">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            Save Module
                        </button>
                        <button onclick="testModule()" class="btn-secondary">
                            <i data-lucide="play" class="w-4 h-4"></i>
                            Test
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Module List Sidebar -->
                    <div class="lg:col-span-1">
                        <div class="form-section">
                            <div class="section-header">
                                <i data-lucide="list" class="w-5 h-5"></i>
                                Modules
                            </div>
                            <div class="module-list" id="configModulesList">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Main Editor -->
                    <div class="lg:col-span-3">
                        <div class="form-section">
                            <div class="tab-nav">
                                <button class="tab-button active" onclick="showConfigTab('basic')">
                                    <i data-lucide="info" class="w-4 h-4"></i>
                                    Basic Info
                                </button>
                                <button class="tab-button" onclick="showConfigTab('objectives')">
                                    <i data-lucide="target" class="w-4 h-4"></i>
                                    Learning Objectives
                                </button>
                                <button class="tab-button" onclick="showConfigTab('prompts')">
                                    <i data-lucide="message-square" class="w-4 h-4"></i>
                                    AI Prompts
                                </button>
                                <button class="tab-button" onclick="showConfigTab('socratic')">
                                    <i data-lucide="help-circle" class="w-4 h-4"></i>
                                    Socratic Method
                                </button>
                            </div>

                            <!-- Basic Info Tab -->
                            <div id="basic-config-tab" class="tab-content active">
                                <div class="form-field">
                                    <label class="form-label">Module Title</label>
                                    <input type="text" class="form-input" id="moduleTitle" placeholder="e.g., Your Four Worlds" value="Your Four Worlds">
                                </div>

                                <div class="form-field">
                                    <label class="form-label">Module Description</label>
                                    <textarea class="form-textarea" id="moduleDescription" placeholder="Brief description of what students will learn">Communication models, perception, and the four worlds we live in - exploring how different communication channels create different realities.</textarea>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div class="form-field">
                                        <label class="form-label">Difficulty Level</label>
                                        <select class="form-select" id="difficultyLevel">
                                            <option value="beginner">Beginner</option>
                                            <option value="intermediate" selected>Intermediate</option>
                                            <option value="advanced">Advanced</option>
                                        </select>
                                    </div>

                                    <div class="form-field">
                                        <label class="form-label">Estimated Duration (minutes)</label>
                                        <input type="number" class="form-input" id="estimatedDuration" value="45" min="15" max="120">
                                    </div>
                                </div>
                            </div>

                            <!-- Learning Objectives Tab -->
                            <div id="objectives-config-tab" class="tab-content">
                                <div class="form-field">
                                    <label class="form-label">Learning Objectives</label>
                                    <p class="text-sm text-slate-600 mb-4">What should students discover or understand by the end of this module?</p>
                                    
                                    <div id="objectivesList">
                                        <div class="flex gap-2 mb-2">
                                            <input type="text" class="form-input" value="Identify the four worlds of communication" placeholder="Learning objective...">
                                            <button type="button" class="btn-secondary px-3" onclick="removeObjective(this)">
                                                <i data-lucide="x" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                        <div class="flex gap-2 mb-2">
                                            <input type="text" class="form-input" value="Understand perception's role in communication" placeholder="Learning objective...">
                                            <button type="button" class="btn-secondary px-3" onclick="removeObjective(this)">
                                                <i data-lucide="x" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn-primary" onclick="addObjective()">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                        Add Objective
                                    </button>
                                </div>
                            </div>

                            <!-- AI Prompts Tab -->
                            <div id="prompts-config-tab" class="tab-content">
                                <div class="form-field">
                                    <label class="form-label">System Prompt</label>
                                    <textarea class="form-textarea" style="min-height: 200px;" id="systemPrompt">You are an expert communication tutor specializing in the Socratic method. Your role is to guide students to discover concepts through strategic questioning rather than providing direct answers.</textarea>
                                </div>

                                <div class="form-field">
                                    <label class="form-label">Module-Specific Prompt</label>
                                    <textarea class="form-textarea" style="min-height: 200px;" id="modulePrompt">For this module on "Your Four Worlds," guide students to discover how perception shapes communication reality and how different channels create different "worlds" of understanding.</textarea>
                                </div>
                            </div>

                            <!-- Socratic Method Tab -->
                            <div id="socratic-config-tab" class="tab-content">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="form-field">
                                        <label class="form-label">Question Intensity</label>
                                        <select class="form-select" id="questionIntensity">
                                            <option value="light">Light - Gentle guidance</option>
                                            <option value="moderate" selected>Moderate - Balanced questioning</option>
                                            <option value="intensive">Intensive - Deep probing</option>
                                        </select>
                                    </div>

                                    <div class="form-field">
                                        <label class="form-label">Follow-up Strategy</label>
                                        <select class="form-select" id="followupStrategy">
                                            <option value="immediate">Immediate follow-up</option>
                                            <option value="delayed" selected>Allow thinking time</option>
                                            <option value="adaptive">Adaptive based on response</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-field">
                                    <label class="form-label">Socratic Flow Outline</label>
                                    <textarea class="form-textarea" style="min-height: 200px;" id="socraticFlow">SOCRATIC FLOW FOR "YOUR FOUR WORLDS":

1. Start with personal experience: "Think about how you got news about [recent event]."
2. Comparative analysis: "How was that different from how your parents might have learned about it?"
3. Perception differences: "Why do you think these sources presented the information differently?"</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ANALYTICS PAGE -->
    <section id="analytics" class="page-section">
        <div class="p-6">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-12">
                    <h1 class="text-4xl font-bold mb-4">Learning Analytics Dashboard</h1>
                    <p class="text-xl text-slate-600">Real-time insights into system performance and learning effectiveness</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="analyticsCards">
                    <!-- Analytics populated by JavaScript -->
                </div>
            </div>
        </div>
    </section>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000/api/v1';
        
        // State
        let currentModule = 1;
        let messageCount = 1;
        let backendConnected = false;
        let currentConversation = null;
        let memoryData = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            initializeApp();
            setupEventListeners();
        });

        // Initialize the application
        async function initializeApp() {
            showStatus('Connecting to backend...', 'connecting');
            
            try {
                await checkBackendConnection();
                await loadModules();
                await loadCurrentModule();
                await loadMemoryData();
                showStatus('Connected', 'connected');
                hideErrorBanner();
            } catch (error) {
                console.error('Initialization failed:', error);
                showStatus('Connection Failed', 'error');
                showErrorBanner('Failed to connect to backend. Make sure the server is running at http://localhost:8000');
            }
        }

        // Check backend connection
        async function checkBackendConnection() {
            const response = await fetch(`${API_BASE}/health/`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            backendConnected = true;
            return data;
        }

        // Show connection status
        function showStatus(status, type) {
            const indicator = document.getElementById('connectionIndicator');
            const statusText = document.getElementById('backendStatus');
            const memoryStatus = document.getElementById('memoryStatus');
            
            statusText.textContent = status;
            
            if (type === 'connected') {
                indicator.classList.add('connected');
                memoryStatus.textContent = 'Active';
            } else if (type === 'error') {
                indicator.classList.remove('connected');
                memoryStatus.textContent = 'Offline';
            } else {
                indicator.classList.remove('connected');
                memoryStatus.textContent = 'Loading...';
            }
        }

        // Show/hide error banner
        function showErrorBanner(message) {
            const banner = document.getElementById('errorBanner');
            const messageEl = document.getElementById('errorMessage');
            messageEl.textContent = message;
            banner.style.display = 'block';
        }

        function hideErrorBanner() {
            document.getElementById('errorBanner').style.display = 'none';
        }

        // Load modules from backend
        async function loadModules() {
            const response = await fetch(`${API_BASE}/modules/`);
            if (!response.ok) throw new Error('Failed to load modules');
            
            const modules = await response.json();
            const modulesList = document.getElementById('modulesList');
            const configModulesList = document.getElementById('configModulesList');
            
            modulesList.innerHTML = '';
            configModulesList.innerHTML = '';
            
            modules.forEach(module => {
                // Chat sidebar module
                const moduleCard = document.createElement('div');
                moduleCard.className = `module-card ${module.id === currentModule ? 'active' : ''}`;
                moduleCard.dataset.module = module.id;
                moduleCard.innerHTML = `
                    <div class="font-medium">Module ${module.id}</div>
                    <div class="text-sm opacity-90">${module.title}</div>
                    <div class="text-xs mt-1 opacity-75">Progress: ${module.progress}% • ${module.id === currentModule ? 'Active' : 'Available'}</div>
                `;
                moduleCard.onclick = () => selectModule(module.id);
                modulesList.appendChild(moduleCard);
                
                // Config page module
                const configModule = document.createElement('div');
                configModule.className = `module-item ${module.id === currentModule ? 'active' : ''}`;
                configModule.innerHTML = `
                    <div class="font-semibold">Module ${module.id}</div>
                    <div class="text-sm text-slate-600">${module.title}</div>
                    <div class="text-xs ${module.configured ? 'text-green-600' : 'text-amber-600'} mt-1">
                        ${module.configured ? '✓ Configured' : '⚠ Needs Setup'}
                    </div>
                `;
                configModulesList.appendChild(configModule);
            });
        }

        // Load current module details
        async function loadCurrentModule() {
            const response = await fetch(`${API_BASE}/modules/${currentModule}`);
            if (!response.ok) throw new Error('Failed to load module');
            
            const module = await response.json();
            
            document.getElementById('chatModuleTitle').textContent = `Module ${module.id}: ${module.title}`;
            
            const moduleInfo = document.getElementById('currentModuleInfo');
            moduleInfo.innerHTML = `
                <h3 class="font-medium mb-3">Module ${module.id}: ${module.title}</h3>
                <div class="mb-3">
                    <h4 class="text-sm font-medium mb-1">Learning Objectives:</h4>
                    <ul class="text-xs text-slate-600 space-y-1">
                        ${module.objectives.map(obj => `<li>• ${obj}</li>`).join('')}
                    </ul>
                </div>
                <div>
                    <h4 class="text-sm font-medium mb-1">Teaching Method:</h4>
                    <div class="text-xs text-slate-600">Socratic questioning to guide discovery</div>
                </div>
            `;
        }

        // Load memory data
        async function loadMemoryData() {
            try {
                const response = await fetch(`${API_BASE}/memory/enhanced/${currentModule}?current_message=`);
                if (!response.ok) throw new Error('Memory system unavailable');
                
                memoryData = await response.json();
                updateMemoryDisplay();
            } catch (error) {
                console.error('Memory system error:', error);
                showMemoryError();
            }
        }

        // Update memory display
        function updateMemoryDisplay() {
            if (!memoryData) return;
            
            const layers = memoryData.memory_layers || {};
            const metrics = memoryData.context_metrics || {};
            
            // Update memory layers
            document.getElementById('memoryLayers').innerHTML = `
                <div class="memory-layer">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="font-semibold text-sm">Layer 1: User Profile</span>
                    </div>
                    <div class="text-xs text-slate-300">
                        <div>Learning Style: ${layers.system_data?.learning_style || 'Visual'}</div>
                        <div>Pace: ${layers.system_data?.pace || 'Moderate'}</div>
                        <div>Background: ${layers.system_data?.background || 'Beginner'}</div>
                    </div>
                </div>
                
                <div class="memory-layer">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="font-semibold text-sm">Layer 2: Module Context</span>
                    </div>
                    <div class="text-xs text-slate-300">
                        <div>Module: ${layers.module_data?.title || 'Communication Fundamentals'}</div>
                        <div>Socratic intensity: ${layers.module_data?.socratic_intensity || 'Moderate'}</div>
                        <div>Progress: ${layers.module_data?.progress || 0}% complete</div>
                    </div>
                </div>
                
                <div class="memory-layer">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="font-semibold text-sm">Layer 3: Conversation</span>
                    </div>
                    <div class="text-xs text-slate-300">
                        <div>Messages exchanged: ${messageCount}</div>
                        <div>Topic focus: ${layers.conversation_data?.topic || 'Communication types'}</div>
                        <div>Engagement level: ${layers.conversation_data?.engagement || 'High'}</div>
                    </div>
                </div>
                
                <div class="memory-layer">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="font-semibold text-sm">Layer 4: Prior Knowledge</span>
                    </div>
                    <div class="text-xs text-slate-300">
                        <div>Cross-module connections: ${layers.prior_knowledge?.connections || 0}</div>
                        <div>Mastered concepts: ${layers.prior_knowledge?.mastered || 0}</div>
                        <div>Knowledge gaps identified: ${layers.prior_knowledge?.gaps || 0}</div>
                    </div>
                </div>
            `;
            
            // Update context metrics
            document.getElementById('contextMetrics').innerHTML = `
                <div class="flex justify-between text-slate-300">
                    <span>Total characters:</span>
                    <span class="text-green-400 font-mono">${metrics.total_chars || 0}</span>
                </div>
                <div class="flex justify-between text-slate-300">
                    <span>Optimization:</span>
                    <span class="text-green-400 font-mono">${metrics.optimization || 0}%</span>
                </div>
                <div class="flex justify-between text-slate-300">
                    <span>Assembly time:</span>
                    <span class="text-green-400 font-mono">${metrics.assembly_time || 0}ms</span>
                </div>
                <div class="flex justify-between text-slate-300">
                    <span>Backend status:</span>
                    <span class="text-green-400 font-mono">Connected</span>
                </div>
            `;
            
            // Update detailed memory page
            updateDetailedMemoryPage();
        }

        // Show memory error
        function showMemoryError() {
            document.getElementById('memoryLayers').innerHTML = `
                <div class="memory-layer error">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                        <span class="font-semibold text-sm">Memory System Error</span>
                    </div>
                    <div class="text-xs text-red-300">
                        Failed to load memory layers. Check backend connection.
                    </div>
                </div>
            `;
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const button = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Disable input
            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 spinner"></i> Sending';
            lucide.createIcons();
            
            // Add user message
            addMessage({
                role: 'user',
                content: message,
                timestamp: new Date().toLocaleTimeString()
            });
            
            input.value = '';
            autoResize(input);
            
            try {
                const response = await fetch(`${API_BASE}/chat/enhanced`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        module_id: currentModule,
                        conversation_id: currentConversation,
                        user_id: 1
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Add AI response
                addMessage({
                    role: 'assistant',
                    content: data.reply,
                    timestamp: new Date().toLocaleTimeString(),
                    enhanced: data.enhanced
                });
                
                // Update conversation ID
                currentConversation = data.conversation_id;
                
                // Update counters
                messageCount += 2;
                
                // Refresh memory
                await loadMemoryData();
                
            } catch (error) {
                console.error('Chat error:', error);
                addMessage({
                    role: 'assistant',
                    content: 'I apologize, but I\'m having trouble connecting to the backend right now. Please make sure the server is running and try again.',
                    timestamp: new Date().toLocaleTimeString(),
                    error: true
                });
            } finally {
                // Re-enable input
                button.disabled = false;
                button.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> Send';
                lucide.createIcons();
            }
        }

        // Add message to chat
        function addMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${message.role}`;
            messageDiv.innerHTML = `
                <div class="message-content">${message.content}</div>
                <div class="message-meta">${message.timestamp}${message.enhanced ? ' • Enhanced memory active' : ''}${message.error ? ' • Error' : ''}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = '44px';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Select module
        async function selectModule(moduleId) {
            currentModule = moduleId;
            currentConversation = null;
            messageCount = 1;
            
            // Update active states
            document.querySelectorAll('.module-card').forEach(card => {
                card.classList.toggle('active', card.dataset.module == moduleId);
            });
            
            // Clear chat and reload data
            document.getElementById('chatMessages').innerHTML = `
                <div class="message assistant">
                    <div class="message-content">
                        Welcome to Module ${moduleId}! I'm your AI tutor, and I'll guide you through discovering key communication concepts using the Socratic method. What would you like to explore first?
                    </div>
                    <div class="message-meta">Just now • Enhanced memory system active</div>
                </div>
            `;
            
            await loadCurrentModule();
            await loadMemoryData();
        }

        // Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load page-specific data
            if (pageId === 'memory') {
                updateDetailedMemoryPage();
            } else if (pageId === 'analytics') {
                loadAnalyticsPage();
            }
        }

        // Update detailed memory page
        function updateDetailedMemoryPage() {
            if (!memoryData) return;
            
            const layers = memoryData.memory_layers || {};
            const metrics = memoryData.context_metrics || {};
            
            // Update detailed layers
            document.getElementById('memoryLayersDetailed').innerHTML = `
                <div class="memory-layer">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="font-semibold">Layer 1: User Profile</span>
                    </div>
                    <div class="text-sm text-slate-600">
                        <div>Learning Style: ${layers.system_data?.learning_style || 'Visual'} learner</div>
                        <div>Pace: ${layers.system_data?.pace || 'Moderate'} progression</div>
                        <div>Background: Communication ${layers.system_data?.background || 'beginner'}</div>
                    </div>
                </div>
                
                <div class="memory-layer">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="font-semibold">Layer 2: Module Context</span>
                    </div>
                    <div class="text-sm text-slate-600">
                        <div>Current: ${layers.module_data?.title || 'Communication Fundamentals'}</div>
                        <div>Socratic intensity: ${layers.module_data?.socratic_intensity || 'Moderate'} questioning</div>
                        <div>Progress: ${layers.module_data?.progress || 0}% module completion</div>
                    </div>
                </div>
                
                <div class="memory-layer">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="font-semibold">Layer 3: Conversation State</span>
                    </div>
                    <div class="text-sm text-slate-600">
                        <div>Messages exchanged: ${messageCount} total</div>
                        <div>Topic focus: ${layers.conversation_data?.topic || 'Getting started'}</div>
                        <div>Engagement level: ${layers.conversation_data?.engagement || 'High'} interaction</div>
                    </div>
                </div>
                
                <div class="memory-layer">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="font-semibold">Layer 4: Prior Knowledge</span>
                    </div>
                    <div class="text-sm text-slate-600">
                        <div>Cross-module connections: ${layers.prior_knowledge?.connections || 0} identified</div>
                        <div>Mastered concepts: ${layers.prior_knowledge?.mastered || 0} confirmed</div>
                        <div>Memory summaries: ${layers.prior_knowledge?.gaps || 0} stored insights</div>
                    </div>
                </div>
            `;
            
            // Update detailed metrics
            document.getElementById('memoryMetricsDetailed').innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="text-center p-4 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">${metrics.total_chars || 0}</div>
                        <div class="text-sm text-slate-600">Context Characters</div>
                    </div>
                    <div class="text-center p-4 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">${metrics.word_count || Math.floor((metrics.total_chars || 0) / 5.5)}</div>
                        <div class="text-sm text-slate-600">Word Count</div>
                    </div>
                    <div class="text-center p-4 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">${metrics.optimization || 0}%</div>
                        <div class="text-sm text-slate-600">Optimization</div>
                    </div>
                    <div class="text-center p-4 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">${metrics.assembly_time || 0}ms</div>
                        <div class="text-sm text-slate-600">Assembly Time</div>
                    </div>
                </div>
            `;
        }

        // Load analytics page
        async function loadAnalyticsPage() {
            try {
                // Try to get real analytics data
                const response = await fetch(`${API_BASE}/health/detailed`);
                let data = {};
                
                if (response.ok) {
                    data = await response.json();
                }
                
                // Fallback to calculated values
                document.getElementById('analyticsCards').innerHTML = `
                    <div class="bg-white rounded-lg border border-slate-200 p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2">${data.memory_assemblies || messageCount * 10}</div>
                        <div class="text-sm text-slate-600">Memory Assemblies Today</div>
                    </div>
                    
                    <div class="bg-white rounded-lg border border-slate-200 p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2">${data.response_time || '84'}ms</div>
                        <div class="text-sm text-slate-600">Avg Response Time</div>
                    </div>
                    
                    <div class="bg-white rounded-lg border border-slate-200 p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2">${data.active_sessions || Math.max(1, messageCount)}</div>
                        <div class="text-sm text-slate-600">Active Learning Sessions</div>
                    </div>
                    
                    <div class="bg-white rounded-lg border border-slate-200 p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2">${data.uptime || (backendConnected ? '99.9%' : '0%')}</div>
                        <div class="text-sm text-slate-600">System Uptime</div>
                    </div>
                `;
            } catch (error) {
                console.error('Analytics load failed:', error);
            }
        }

        // Configuration functions
        function showConfigTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName + '-config-tab').classList.add('active');
            event.target.classList.add('active');
        }

        function addObjective() {
            const list = document.getElementById('objectivesList');
            const div = document.createElement('div');
            div.className = 'flex gap-2 mb-2';
            div.innerHTML = `
                <input type="text" class="form-input" placeholder="New learning objective...">
                <button type="button" class="btn-secondary px-3" onclick="removeObjective(this)">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            list.appendChild(div);
            lucide.createIcons();
        }

        function removeObjective(button) {
            button.parentElement.remove();
        }

        async function saveModule() {
            const saveStatus = document.getElementById('saveStatus');
            saveStatus.className = 'save-status';
            saveStatus.textContent = 'Saving...';
            saveStatus.style.display = 'block';

            await new Promise(resolve => setTimeout(resolve, 1000));

            saveStatus.className = 'save-status success';
            saveStatus.textContent = '✓ Module saved successfully';
            
            setTimeout(() => {
                saveStatus.style.display = 'none';
            }, 3000);
        }

        function testModule() {
            showPage('chat');
        }

        // Event listeners
        function setupEventListeners() {
            const messageInput = document.getElementById('messageInput');
            
            if (messageInput) {
                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                messageInput.addEventListener('input', function() {
                    autoResize(this);
                });
            }

            document.querySelectorAll('.module-card, .module-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.module-card, .module-item').forEach(m => m.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // Auto-check connection every 30 seconds
        setInterval(async () => {
            try {
                await checkBackendConnection();
                if (!backendConnected) {
                    showStatus('Connected', 'connected');
                    hideErrorBanner();
                    backendConnected = true;
                }
            } catch (error) {
                if (backendConnected) {
                    showStatus('Connection Lost', 'error');
                    showErrorBanner('Backend connection lost. Trying to reconnect...');
                    backendConnected = false;
                }
            }
        }, 30000);
    </script>
</body>
</html>
